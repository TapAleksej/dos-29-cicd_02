pipeline {
  agent any

  parameters {
    booleanParam(name: 'RUN_DEPLOY', defaultValue: false, description: 'Run deploy job')
    gitParameter(type: 'PT_BRANCH', name: 'BRANCH', branchFilter: 'origin/(.*)', description: 'Choose a branch to checkout', sortMode: 'DESCENDING_SMART')
  }

  environment {
    REPO = "alrexcom/dos-29"
    PRJ_NAME = "ecom"
    GIT_URL = "git@github.com:TapAleksej/dos-29-cicd_02.git"
  }

  stages {
    stage('Checkout Repo'){
      steps {
        script {
          git branch: "${params.BRANCH}", url: "${env.GIT_URL}"
        }
      }
    }

    stage('Build Image'){
      steps {
        script {
          sh """
            set -x;
            docker build -t "${env.REPO}:${env.PRJ_NAME}-${BUILD_NUMBER}" .
            set +x;
          """
        }
    } 
    }

    stage('Push Image') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-token', usernameVariable: 'username', passwordVariable: 'password')]) {
          script {
            sh """
              docker login -u ${username} -p ${password}
              docker push "${env.REPO}:${env.PRJ_NAME}-${BUILD_NUMBER}"
            """
          }
        }
      }
    }

    stage('Call Deploy Job') {
      when {
        expression { return params.RUN_DEPLOY }
      }
      steps {
        script {
          build quietPeriod: 5, wait: false, job: 'deploy', parameters: [string(name: 'DOCKER_IMAGE', value: "${env.REPO}:${env.PRJ_NAME}-${BUILD_NUMBER}")]
        }
      }
    }
  }
}
